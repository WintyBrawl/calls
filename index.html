<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skype - –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* ... (–≤—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo">
                <i class="fab fa-skype"></i>
                <span>Skype</span>
            </div>
        </div>
    </header>

    <!-- Firebase Status -->
    <div id="firebase-status" class="firebase-status firebase-disconnected">Firebase: –û—Ç–∫–ª—é—á–µ–Ω–æ</div>

    <!-- Browser Support Warning -->
    <div id="browser-warning" class="browser-warning">
        <p><strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –í–∞—à –±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä (Chrome, Firefox, Edge) –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –ø–æ HTTPS.</p>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Login Section -->
        <div class="login-section" id="login-section">
            <h2>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è</h2>
            <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –¥—Ä—É–∑—å—è–º–∏ –∏ —Å–µ–º—å–µ–π —á–µ—Ä–µ–∑ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏</p>
            <input type="text" id="username-input" placeholder="–í–∞—à–µ –∏–º—è" maxlength="20">
            <button id="login-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
        
        <!-- Profile Section -->
        <div class="profile-section" id="profile-section">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="username-display"></span>!</h2>
            <p>–í–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</p>
            <div class="info-box">
                <span id="user-id" class="user-id"></span>
                <button id="copy-id-btn" class="copy-btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
            </div>
            
            <p>–ß—Ç–æ–±—ã –ø–æ–∑–≤–æ–Ω–∏—Ç—å –¥—Ä—É–≥—É, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ ID:</p>
            <input type="text" id="friend-id-input" class="call-input" placeholder="ID –¥—Ä—É–≥–∞">
            <button id="call-btn" class="call-btn">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
            <button id="logout-btn" class="logout-btn">–í—ã–π—Ç–∏</button>
        </div>
        
        <!-- Call Section -->
        <div class="call-section" id="call-section">
            <h2>–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</h2>
            <div class="call-status" id="call-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
            <div class="video-container">
                <div class="video-wrapper">
                    <video id="local-video" autoplay muted playsinline></video>
                    <div class="video-label">–í—ã</div>
                </div>
                <div class="video-wrapper">
                    <video id="remote-video" autoplay playsinline></video>
                    <div class="video-label">–î—Ä—É–≥</div>
                </div>
            </div>
            
            <div class="call-controls">
                <button id="toggle-audio" class="control-btn toggle-audio">üé§</button>
                <button id="toggle-video" class="control-btn toggle-video">üìπ</button>
                <button id="end-call" class="control-btn end-call">üìû</button>
            </div>
        </div>
    </div>

    <!-- Incoming Call -->
    <div id="incoming-call" class="incoming-call">
        <h3>–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫!</h3>
        <p>–û—Ç: <span id="caller-id"></span></p>
        <div class="incoming-call-buttons">
            <button id="accept-call" class="accept-call">–ü—Ä–∏–Ω—è—Ç—å</button>
            <button id="reject-call" class="reject-call">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification">ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!</div>

    <script>
        // === Firebase Configuration ===
        const firebaseConfig = {
            apiKey: "AIzaSyDTx2Y9ctiWp26YeMmAHAxDZd_gVI_ZMdw",
            authDomain: "kcalls.firebaseapp.com",
            databaseURL: "https://kcalls-default-rtdb.firebaseio.com",
            projectId: "kcalls",
            storageBucket: "kcalls.firebasestorage.app",
            messagingSenderId: "990117089104",
            appId: "1:990117089104:web:278a42c037e975ebb76655",
            measurementId: "G-TK6GVEX9G5"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.log('Firebase —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        }
        const database = firebase.database();

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const loginSection = document.getElementById('login-section');
        const profileSection = document.getElementById('profile-section');
        const callSection = document.getElementById('call-section');
        const usernameInput = document.getElementById('username-input');
        const loginBtn = document.getElementById('login-btn');
        const usernameDisplay = document.getElementById('username-display');
        const userIdDisplay = document.getElementById('user-id');
        const copyIdBtn = document.getElementById('copy-id-btn');
        const friendIdInput = document.getElementById('friend-id-input');
        const callBtn = document.getElementById('call-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const toggleAudioBtn = document.getElementById('toggle-audio');
        const toggleVideoBtn = document.getElementById('toggle-video');
        const endCallBtn = document.getElementById('end-call');
        const notification = document.getElementById('notification');
        const callStatus = document.getElementById('call-status');
        const incomingCallDiv = document.getElementById('incoming-call');
        const callerIdSpan = document.getElementById('caller-id');
        const acceptCallBtn = document.getElementById('accept-call');
        const rejectCallBtn = document.getElementById('reject-call');
        const firebaseStatus = document.getElementById('firebase-status');
        const browserWarning = document.getElementById('browser-warning');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let localStream = null;
        let isAudioEnabled = true;
        let isVideoEnabled = true;
        let userId = null;
        let peerConnection = null;
        let isCaller = false;
        let targetUserId = null;
        let callerId = null;
        let username = '';

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è STUN/TURN —Å–µ—Ä–≤–µ—Ä–æ–≤
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ],
            iceCandidatePoolSize: 10
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º
        function checkBrowserSupport() {
            const supported = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            
            if (!supported) {
                browserWarning.style.display = 'block';
                console.error('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç getUserMedia');
            }
            
            return supported;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
        async function getMediaStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 24 }
                    }, 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                return stream;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º:', error);
                throw error;
            }
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message) {
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ Firebase
        function updateFirebaseStatus(connected) {
            if (connected) {
                firebaseStatus.textContent = 'Firebase: –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                firebaseStatus.className = 'firebase-status firebase-connected';
            } else {
                firebaseStatus.textContent = 'Firebase: –û—Ç–∫–ª—é—á–µ–Ω–æ';
                firebaseStatus.className = 'firebase-status firebase-disconnected';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–≤–æ–Ω–∫–∞
        function updateCallStatus(message, type = 'waiting') {
            callStatus.textContent = message;
            callStatus.className = `call-status ${type}`;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
        function showSection(section) {
            loginSection.style.display = 'none';
            profileSection.style.display = 'none';
            callSection.style.display = 'none';
            section.style.display = 'block';
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firebase
        function setupFirebase() {
            // –°–ª—É—à–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            database.ref('.info/connected').on('value', (snapshot) => {
                updateFirebaseStatus(snapshot.val() === true);
            });

            // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            database.ref('users/' + userId).set({
                username: username,
                online: true,
                lastSeen: Date.now()
            });

            // –°–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            database.ref('messages/' + userId).on('child_added', (snapshot) => {
                const message = snapshot.val();
                handleSignalingMessage(message);
                
                // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                setTimeout(() => {
                    snapshot.ref.remove();
                }, 5000);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            setInterval(() => {
                if (userId) {
                    database.ref('users/' + userId).update({
                        lastSeen: Date.now()
                    });
                }
            }, 10000);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Firebase
        function sendMessage(message) {
            message.timestamp = Date.now();
            message.senderId = userId;
            
            if (message.targetId) {
                database.ref('messages/' + message.targetId).push(message);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkBrowserSupport()) {
                loginBtn.disabled = true;
                loginBtn.textContent = '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            }
        });

        // –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
        loginBtn.addEventListener('click', () => {
            const name = usernameInput.value.trim();
            if (name) {
                username = name;
                userId = generateUserId();
                usernameDisplay.textContent = username;
                userIdDisplay.textContent = userId;
                
                setupFirebase();
                showSection(profileSection);
                showNotification('–í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É!');
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function handleSignalingMessage(message) {
            console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message.type, '–æ—Ç', message.senderId);
            
            if (message.type === 'offer' && message.senderId !== userId) {
                callerId = message.senderId;
                callerIdSpan.textContent = message.callerName || callerId;
                showIncomingCall();
                window.pendingOffer = message.offer;
                
            } else if (message.type === 'answer' && isCaller && message.senderId === targetUserId) {
                console.log('–ü–æ–ª—É—á–µ–Ω answer –æ—Ç', message.senderId);
                if (peerConnection && peerConnection.signalingState === 'have-local-offer') {
                    peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer))
                        .then(() => {
                            console.log('Remote description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                            updateCallStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'connected');
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ remote description:', error);
                        });
                }
                
            } else if (message.type === 'ice-candidate' && message.senderId === targetUserId) {
                console.log('–ü–æ–ª—É—á–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç', message.senderId);
                if (peerConnection) {
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê ICE –ö–ê–ù–î–ò–î–ê–¢–û–í
                    const candidateData = message.candidate;
                    const iceCandidate = new RTCIceCandidate({
                        candidate: candidateData.candidate,
                        sdpMid: candidateData.sdpMid || null,
                        sdpMLineIndex: candidateData.sdpMLineIndex !== undefined ? candidateData.sdpMLineIndex : null,
                        usernameFragment: candidateData.usernameFragment || null
                    });
                    
                    peerConnection.addIceCandidate(iceCandidate)
                        .then(() => {
                            console.log('ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:', error);
                        });
                }
                    
            } else if (message.type === 'reject' && isCaller) {
                updateCallStatus('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'error');
                setTimeout(() => endCall(), 2000);
            } else if (message.type === 'end-call') {
                updateCallStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'error');
                setTimeout(() => endCall(), 2000);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
        function showIncomingCall() {
            incomingCallDiv.style.display = 'block';
        }

        // –°–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
        function hideIncomingCall() {
            incomingCallDiv.style.display = 'none';
            callerId = null;
        }

        // –ü—Ä–∏–Ω—è—Ç—å –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
        acceptCallBtn.addEventListener('click', async () => {
            if (callerId) {
                targetUserId = callerId;
                isCaller = false;
                hideIncomingCall();
                await startCall();
            }
        });

        // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
        rejectCallBtn.addEventListener('click', () => {
            if (callerId) {
                sendMessage({
                    type: 'reject',
                    targetId: callerId
                });
                hideIncomingCall();
                showNotification('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
            }
        });

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ ID
        copyIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(userId).then(() => {
                showNotification('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            });
        });

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        logoutBtn.addEventListener('click', () => {
            usernameInput.value = '';
            if (userId) {
                database.ref('users/' + userId).remove();
                database.ref('messages/' + userId).remove();
            }
            showSection(loginSection);
        });

        // –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
        callBtn.addEventListener('click', async () => {
            targetUserId = friendIdInput.value.trim();
            if (!targetUserId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞');
                return;
            }

            if (targetUserId === userId) {
                alert('–ù–µ–ª—å–∑—è –ø–æ–∑–≤–æ–Ω–∏—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ');
                return;
            }

            callBtn.disabled = true;
            callBtn.textContent = '–í—ã–∑–æ–≤...';

            try {
                isCaller = true;
                await startCall();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∑–≤–æ–Ω–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∑–≤–æ–Ω–∫–∞: ' + error.message);
                callBtn.disabled = false;
                callBtn.textContent = '–ü–æ–∑–≤–æ–Ω–∏—Ç—å';
            }
        });

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        endCallBtn.addEventListener('click', () => {
            endCall();
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ
        toggleAudioBtn.addEventListener('click', () => {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                isAudioEnabled = !isAudioEnabled;
                toggleAudioBtn.textContent = isAudioEnabled ? 'üé§' : 'üîá';
                toggleAudioBtn.style.backgroundColor = isAudioEnabled ? '#0078d7' : '#e81123';
                showNotification(isAudioEnabled ? '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω' : '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
            }
        });

        toggleVideoBtn.addEventListener('click', () => {
            if (localStream) {
                const videoTracks = localStream.getVideoTracks();
                videoTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                isVideoEnabled = !isVideoEnabled;
                toggleVideoBtn.textContent = isVideoEnabled ? 'üìπ' : 'üì∑';
                toggleVideoBtn.style.backgroundColor = isVideoEnabled ? '#0078d7' : '#e81123';
                showNotification(isVideoEnabled ? '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞' : '–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞');
            }
        });

        // –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
        async function startCall() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫
                localStream = await getMediaStream();
                
                localVideo.srcObject = localStream;
                showSection(callSection);
                updateCallStatus('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...', 'waiting');
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection
                createPeerConnection();
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                if (isCaller) {
                    updateCallStatus('–í—ã–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...', 'waiting');
                    
                    // –°–æ–∑–¥–∞–µ–º offer
                    const offer = await peerConnection.createOffer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: true
                    });
                    
                    await peerConnection.setLocalDescription(offer);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer
                    sendMessage({
                        type: 'offer',
                        callerId: userId,
                        callerName: username,
                        offer: offer,
                        targetId: targetUserId
                    });

                    showNotification('–í—ã–∑–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');

                } else {
                    // –ü—Ä–∏–Ω–∏–º–∞–µ–º –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
                    if (window.pendingOffer) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(window.pendingOffer));
                        
                        const answer = await peerConnection.createAnswer({
                            offerToReceiveAudio: true,
                            offerToReceiveVideo: true
                        });
                        
                        await peerConnection.setLocalDescription(answer);
                        
                        sendMessage({
                            type: 'answer',
                            answer: answer,
                            targetId: targetUserId
                        });
                        
                        updateCallStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'connected');
                        delete window.pendingOffer;
                    }
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–≤–æ–Ω–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
                showSection(profileSection);
                callBtn.disabled = false;
                callBtn.textContent = '–ü–æ–∑–≤–æ–Ω–∏—Ç—å';
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ PeerConnection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –ø–æ—Ç–æ–∫–æ–≤
            peerConnection.ontrack = (event) => {
                console.log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫:', event.streams);
                if (event.streams && event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    updateCallStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'connected');
                    showNotification('–í–∏–¥–µ–æ—Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
                }
            };
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && targetUserId) {
                    console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞');
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê ICE –ö–ê–ù–î–ò–î–ê–¢–û–í
                    sendMessage({
                        type: 'ice-candidate',
                        candidate: {
                            candidate: event.candidate.candidate,
                            sdpMid: event.candidate.sdpMid,
                            sdpMLineIndex: event.candidate.sdpMLineIndex,
                            usernameFragment: event.candidate.usernameFragment
                        },
                        targetId: targetUserId
                    });
                }
            };
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.onconnectionstatechange = () => {
                console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', peerConnection.connectionState);
                switch(peerConnection.connectionState) {
                    case 'connected':
                        updateCallStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'connected');
                        break;
                    case 'disconnected':
                        updateCallStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ', 'error');
                        break;
                    case 'failed':
                        updateCallStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                        setTimeout(() => endCall(), 3000);
                        break;
                    case 'closed':
                        updateCallStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'error');
                        break;
                }
            };

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ ICE —Å–æ—Å—Ç–æ—è–Ω–∏—è
            peerConnection.oniceconnectionstatechange = () => {
                console.log('ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', peerConnection.iceConnectionState);
                if (peerConnection.iceConnectionState === 'failed') {
                    console.log('ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ failed');
                    updateCallStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                }
            };
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        function endCall() {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞
            if (targetUserId) {
                sendMessage({
                    type: 'end-call',
                    targetId: targetUserId
                });
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            isCaller = false;
            targetUserId = null;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            callBtn.disabled = false;
            callBtn.textContent = '–ü–æ–∑–≤–æ–Ω–∏—Ç—å';
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
            showSection(profileSection);
            showNotification('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (userId) {
                database.ref('users/' + userId).remove();
                database.ref('messages/' + userId).remove();
            }
        });

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        setInterval(() => {
            database.ref('messages').once('value').then((snapshot) => {
                const messages = snapshot.val() || {};
                const now = Date.now();
                Object.keys(messages).forEach(userId => {
                    Object.keys(messages[userId]).forEach(messageId => {
                        if (now - messages[userId][messageId].timestamp > 30000) {
                            database.ref('messages/' + userId + '/' + messageId).remove();
                        }
                    });
                });
            });
        }, 30000);
    </script>
</body>
</html>